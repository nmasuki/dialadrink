var cartUtil=function(){var n={},i=null,c="/api/";function o(e){var t=e.product.priceOptions.find(function(t){return t.option.quantity===e.quantity}),a=e.price||(t.offerPrice&&t.price>t.offerPrice?t.offerPrice:t.price);return e._id=e._id||e.product._id+"|"+e.quantity,e.image=e.image||e.product.image,e.currency=e.currency||t.currency,e.price=a,e}var d=Object.assign(this,{view:function(t){var e=$("#cart-content-main, #cart-content-mini");return t?e.find(t):e},init:function(){return $.get(c+"cart/get").then(function(t){for(var e in n=t.cart,i=t.promo,n)n[e]=o(n[e]);d.updateView()})},getCart:function(){return n},getCartItem:function(t){return n[t]},addItem:function(t,e,a){d.view(".number");var i=t+"|"+(a=a||""),r=n[i]||(n[i]={_id:i,pieces:0});return r.pieces+=e,d.updateView(),app&&app.showToast&&app.showToast("Adding to cart!"),d.viewNotUpdated=!0,$.ajax({url:c+"cart/add/"+t+"/"+a+"/"+(e||1),type:"get",success:function(t){console.log("Added to cart",t,e),app.showToast(e+" "+t.item.product.name+" added to cart!",1500,"green"),n[i]=o(Object.assign(r,t.item)),d.updateView(),"function"==typeof window.subscribeToPush&&window.subscribeToPush()},fail:function(){console.warn("Added to cart fails. Could not reach Server"),app.showToast("Added to cart fails. Could not reach Server!",1500,"red"),r.pieces-=e,d.updateView(),d.viewNotUpdated=!1}})},updateItem:function(e,t){if(t<=0)return d.removeItem(e);var a=n[e]||(n[e]={_id:e,pieces:t});return d.updateView(),$.ajax({url:c+"cart/update/"+e+"/"+t,type:"get",success:function(t){n[e]=o(Object.assign(a,t.item)),d.updateView()}})},removeItem:function(e){var a=this;if(!n[e])throw"Cart item not found! "+e;var i=a.view("li[data-cartid='"+e+"']");return i.slideUp(),$.ajax({url:c+"cart/remove/"+e,type:"get",success:function(t){t.state?(delete n[e],a.updateView()):(i.slideDown(),app.showToast("Failed to remove cart item "+t.msg,1500,"red"))}})},piecesCount:function(){var t=0;for(var e in n)t+=parseInt(n[e].pieces);return t},productCount:function(){return Object.values(n||{}).distinct(function(t){return t.product&&t.product._id}).length},totalCost:function(){var t=0;for(var e in n)t+=n[e].pieces*n[e].price;return t},totalAmount:function(){var t=d.totalCost();return t-d.discount(t)},discount:function(t,e){return t=t||d.totalCost(),(e=e||i)&&e.discountType?Math.round("percent"===e.discountType?t*e.discount/100:e.discount):0},updateView:function(e,t){e=e||n||{},t=t||i,Object.values(e).forEach(d.updateCartItemView),Object.keys(n||{}).forEach(function(t){(!e[t]||e[t].pieces<=0)&&d.view("li[data-cartid='"+t+"']").slideUp()});var a=$(".promo-code-wrapper");t&&t.discountType&&d.discount(null,t)?(a.find(".promo-code").text(t.code),a.find(".promo-code-amount").text(d.discount(null,t).formatNumber(2)),a.slideDown()):a.hide(),n=e,i=t,d.updateTotals()},updateCartItemView:function(e){if("string"==typeof e&&(e=d.getCartItem(e)),!e)throw"Missing [item] when updating cart item view";if(!e._id)throw"Missing [item._id] when updating cart item view";var t=function(i){var t=d.view().find("[data-cartid='"+i+"']");if(t.length<=0){var r=$("#cart-template").html();d.view().each(function(t,e){var a=$(r);a.find("li").data("cartId",i),$(e).prepend(a)}),t=d.view().find("[data-cartid='"+i+"']")}return t}(e._id);if(e.pieces<=0?t.slideUp():t.slideDown(),t.find(".cart-description").html((e.description||"").truncate(50)),t.find(".cart-price").html((e.pieces*e.price).formatNumber(2)),t.find(".cart-pieces").html(e.pieces),e.product=e.product||function(t){return{_id:t.split("|").first(),href:"",name:"",currency:"",priceOptions:[{option:{quantity:t.split("|").last(),currency:""}}],image:{secure_url:null}}}(e._id),e.product){if(t.find(".cart-image").attr("src",e.product.image.secure_url),t.find(".cart-product-link").attr("href",e.product.href).html(e.product.name+" "+e.quantity),e.product.priceOptions){var a=e.product.priceOptions.find(function(t){return t.option.quantity===e.quantity});t.find(".cart-currency").html(e.currency||a&&a.currency||"KES"),t.find(".cart-price").html((e.pieces*e.price).formatNumber(2))}}else app.cartUtil.viewNotUpdated=!0},updateTotals:function(){$(".cart-total-products").html(d.productCount()),$(".cart-total-pieces").html(d.piecesCount()),["/checkout","/cart"].find(function(t){return 0<=window.location.href.indexOf(t)})?($(".shop-by-brand").hide(),$(".inst-checkout").hide()):0<d.piecesCount()?$(".inst-checkout").slideDown():$(".inst-checkout").slideUp();var t=d.totalAmount().formatNumber(2);d.totalAmount()!==d.totalCost()&&(t="<span style='font-size: 0.8em; text-decoration: line-through; color: orangered'>{0}</span>".format(d.totalCost().formatNumber(2))+t),$(".cart-total").html(t)}});return d.init(),d};window.app=window.app||{cartUtil:new cartUtil},$(function(){$(document).on("click",".add-to-cart",function(t){t.preventDefault();var e=$(this).data("product"),a=$(this).data("qty");if(e){console.log("The id is this after changes",e);var i=$(this).parents("#product-section").find(".pieces"),r=parseInt(i.val())||1;app.cartUtil.addItem(e,r,a)}else console.warn("Could not add to cart, [data-product] attribute missing on.",$(this))}),$(document).on("mouseover",".num-items-in-cart",function(t){var i=$(this);!app.cartUtil.viewNotUpdated&&window.cartXHR&&"resolved"!=window.cartXHR.state()||(window.cartXHR=$.ajax("/cart/mini").then(function(t,e,a){"string"==typeof t?(i.data("loadedAt",(new Date).getTime()),$("#cart-info").html(t),app.cartUtil.viewNotUpdated=!1):app.cartUtil.updateView(window.cart=t)}))}),$(document).on("change",".cart-pieces",function(t){t.preventDefault();var e=$(this).val(),a=$(this).parents("[data-cartid]").data("cartid");app.cartUtil.updateItem(a,e)}),$(document).on("click",".cart-remove",function(t){t.preventDefault();var e=$(this).parents("[data-cartid]").data("cartid");app.cartUtil.removeItem(e)}),$(document).on("click",".pieces-minus",function(){var t=$(this).siblings(".pieces"),e=parseInt(t.val())||1;t.val(--e);var a=$(this).parents("[data-cartid]").data("cartid");a?app.cartUtil.updateItem(a,e):console.warn("Could not get cart id!!")}),$(document).on("click",".pieces-plus",function(){var t=$(this).siblings(".pieces"),e=parseInt(t.val())||1;t.val(++e);var a=$(this).parents("[data-cartid]").data("cartid");a?app.cartUtil.updateItem(a,e):console.warn("Could not get cart id!!")}),$(document).on("change","#change-quantity",function(t){t.preventDefault();var e=$(this).find(":selected").data("option");console.log(e),$("#product-data").attr("data-product",e);var a=$(this).val();$("#product-price").html(a);var i=$(this).find(":selected").text().trim();$(".add-to-cart").data("qty",i)}),$(document).on("click","#checkout-form",function(t){t.preventDefault();var e=$("#name").val(),a=$("#phone").val(),i=$("#location").val(),r=$("#street").val(),n=$("#building").val(),c=$("#houseno").val(),o=app.csrf_token,d=$("#email").val();if(""!=e&&""!=a&&""!=i&&""!=d)data={street:r,building:n,houseno:c,name:e,cell:a,location:i,email:d,_csrf:o},$.ajax({headers:{"X-CSRF-Token":app.csrf_token},type:"get",url:"/cart/checkout/"+e+"/"+i+"/"+a+"/"+d+"/"+r+"/"+n+"/"+c,data:data,success:function(t){console.log(t),t.state&&(window.location.href="/order-placed")},error:function(t,e,a){console.log(t,e,a)}});else{$(".checkout-error").html("Please fill all the fields and try again")}})});