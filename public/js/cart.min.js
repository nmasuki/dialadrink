var cartUtil=function(){var self=this,_cart={},_promo=null,_url="/api/",locationNai={lat:-1.2829442,lng:36.8227554};function distance(t,e,a){if(t.lat==e.lat&&t.lng==e.lng)return 0;var r=Math.PI*t.lat/180,n=Math.PI*e.lat/180,i=t.lng-e.lng,o=Math.PI*i/180,c=Math.sin(r)*Math.sin(n)+Math.cos(r)*Math.cos(n)*Math.cos(o);return 1<c&&(c=1),c=60*(c=180*(c=Math.acos(c))/Math.PI)*1.1515,"K"==a&&(c*=1.609344),"N"==a&&(c*=.8684),c}function distanceFromNai(t){return distance(t,locationNai,"K")}function loadRegionData(e){if(!self.locations||!self.locations.length)return $.get(_url+"locations").then(function(t){if("success"==t.response)return self.locations=t.data,loadRegionData(e)});e=window.addressData&&window.addressData.location||locationNai;var t=self.locations.filter(function(t){return t.viewport}).filter(function(t){return function(t,e){var a,r=t.lng<e.northeast.lng,n=t.lng>e.southwest.lng;return a=e.northeast.lng<e.southwest.lng?r||n:r&&n,t.lat>e.southwest.lat&&t.lat<e.northeast.lat&&a}(e,t.viewport)}).orderBy(function(t){return-distanceFromNai(t.location)}),a=self.locations.map(function(t){return{d:distanceFromNai(t.location),c:t.deliveryCharges,p:t.deliveryCharges/distanceFromNai(t.location)}});console.log(a);var r=distanceFromNai(e);return window.regionData=Object.assign({freeDeliveryThreashold:Math.min(100*r,500),deliveryCharges:100*r},t.last()||{}),console.log(r,window.regionData),$.Deferred().resolve(window.regionData.deliveryCharges)}function getProductFromView(t){return{_id:t.split("|").first(),href:"",name:"",currency:"",priceOptions:[{option:{quantity:t.split("|").last(),currency:""}}],image:{secure_url:null}}}function getItemView(r){var t=self.view().find("[data-cartid='"+r+"']");if(t.length<=0){var n=$("#cart-template").html();self.view().each(function(t,e){var a=$(n);a.find("li").data("cartId",r),$(e).prepend(a)}),t=self.view().find("[data-cartid='"+r+"']")}return t}function fillIn(e){var t=e.product.priceOptions.find(function(t){return t.option.quantity===e.quantity}),a=e.price||(t.offerPrice&&t.price>t.offerPrice?t.offerPrice:t.price);return e._id=e._id||e.product._id+"|"+e.quantity,e.image=e.image||e.product.image,e.currency=e.currency||t.currency,e.price=a,e}return self=Object.assign(self,{view:function(t){var e=$("#cart-content-main, #cart-content-mini");return t?e.find(t):e},init:function(){return loadRegionData(),$.get(_url+"cart/get").then(function(t){for(var e in _cart=t.cart,_promo=t.promo,_cart)_cart[e]=fillIn(_cart[e]);self.updateView()})},getCart:function(){return _cart},loadCharges:loadRegionData,getCharges:function(){var charges={};window.regionData&&window.regionData.freeDeliveryThreashold&&self.totalCost()<window.regionData.freeDeliveryThreashold&&(charges.deliveryCharges=window.regionData.deliveryCharges);var paymentMode=$("[name=paymentMethod]:checked").val();if(paymentMode){var mapping={"Swipe on Delivery":"2.5%",PesaPal:"3%"};if(mapping[paymentMode]){var v=mapping[paymentMode].replace("%","/100");/[^\d\.]/.test(v)&&(v=eval(v)*self.totalCost()),charges.transactionCharges=v}}return charges},getCartItem:function(t){return _cart[t]},addItem:function(t,e,a){self.view(".number");var r=t+"|"+(a=a||""),n=_cart[r]||(_cart[r]={_id:r,pieces:0});return n.pieces+=e,self.updateView(),app&&app.showToast&&app.showToast("Adding to cart!"),self.viewNotUpdated=!0,$.ajax({url:_url+"cart/add/"+t+"/"+a+"/"+(e||1),type:"get",success:function(t){console.log("Added to cart",t,e),app.showToast(e+" "+t.item.product.name+" added to cart!",1500,"green"),_cart[r]=fillIn(Object.assign(n,t.item)),self.updateView(),"function"==typeof window.subscribeToPush&&window.subscribeToPush()},fail:function(){console.warn("Added to cart fails. Could not reach Server"),app.showToast("Added to cart fails. Could not reach Server!",1500,"red"),n.pieces-=e,self.updateView(),self.viewNotUpdated=!1}})},updateItem:function(e,t){if(t<=0)return self.removeItem(e);var a=_cart[e]||(_cart[e]={_id:e,pieces:t});return self.updateView(),$.ajax({url:_url+"cart/update/"+e+"/"+t,type:"get",success:function(t){_cart[e]=fillIn(Object.assign(a,t.item)),self.updateView()}})},removeItem:function(e){var a=this;if(!_cart[e])throw"Cart item not found! "+e;var r=a.view("li[data-cartid='"+e+"']");return r.slideUp(),$.ajax({url:_url+"cart/remove/"+e,type:"post",success:function(t){t.state?(delete _cart[e],a.updateView()):(r.slideDown(),app.showToast("Failed to remove cart item "+t.msg,1500,"red"))}})},piecesCount:function(){var t=0;for(var e in _cart)t+=parseInt(_cart[e].pieces);return t},productCount:function(){return Object.values(_cart||{}).distinct(function(t){return t.product&&t.product._id}).length},totalCost:function(){var t=0;for(var e in _cart)t+=_cart[e].pieces*_cart[e].price;return t},totalAmount:function(){var t=self.totalCost(),e=0,a=self.getCharges()||{};for(var r in a)a.hasOwnProperty(r)&&(e+=a[r]);return t+e-self.discount(t)},discount:function(t,e){return t=t||self.totalCost(),(e=e||_promo)&&e.discountType?Math.round("percent"===e.discountType?t*e.discount/100:e.discount):0},updateView:function(e,t){e=e||_cart||{},t=t||_promo,Object.values(e).forEach(self.updateCartItemView),Object.keys(_cart||{}).forEach(function(t){(!e[t]||e[t].pieces<=0)&&self.view("li[data-cartid='"+t+"']").slideUp()});var a=$(".promo-code-wrapper");t&&t.discountType&&self.discount(null,t)?(a.find(".promo-code").text(t.code),a.find(".promo-code-amount").text(self.discount(null,t).formatNumber(2)),a.slideDown()):a.hide();var r=app.cartUtil.getCharges(),n=$(".transaction-charges"),i=$(".delivery-charges");r.transactionCharges?(n.find(".cart-amount").text(r.transactionCharges.formatNumber(2)),n.slideDown()):n.slideUp(),r.deliveryCharges?(i.find(".cart-amount").text(r.deliveryCharges.formatNumber(2)),i.slideDown()):i.slideUp(),console.log(r),_cart=e,_promo=t,self.updateTotals()},updateCartItemView:function(e){if("string"==typeof e&&(e=self.getCartItem(e)),!e)throw"Missing [item] when updating cart item view";if(!e._id)throw"Missing [item._id] when updating cart item view";var t=getItemView(e.cartId||e._id+"|"+e.quantity);if(e.pieces<=0?t.slideUp():t.slideDown(),t.find(".cart-description").html((e.description||"").truncate(50)),t.find(".cart-price").html((e.pieces*e.price).formatNumber(2)),t.find(".cart-pieces").html(e.pieces),e.product=e.product||getProductFromView(e._id),e.product){if(t.find(".cart-image").attr("src",e.product.image.secure_url),t.find(".cart-product-link").attr("href",e.product.href).html(e.product.name+" "+e.quantity),e.product.priceOptions){var a=e.product.priceOptions.find(function(t){return t.option.quantity===e.quantity});t.find(".cart-currency").html(e.currency||a&&a.currency||"KES"),t.find(".cart-price").html((e.pieces*e.price).formatNumber(2))}}else app.cartUtil.viewNotUpdated=!0},updateTotals:function(){$(".cart-total-products").html(self.productCount()),$(".cart-total-pieces").html(self.piecesCount()),["/checkout","/cart"].find(function(t){return 0<=window.location.href.indexOf(t)})?($(".shop-by-brand").hide(),$(".inst-checkout").hide()):0<self.piecesCount()?$(".inst-checkout").slideDown():$(".inst-checkout").slideUp();var t=self.totalAmount().formatNumber(2);self.totalAmount()!==self.totalCost()&&(t="<span style='font-size: 0.8em; text-decoration: line-through; color: orangered'>{0}</span>".format(self.totalCost().formatNumber(2))+t),$(".cart-total, .cart-total-2").html(t)}}),self.init(),self};window.app=window.app||{cartUtil:new cartUtil},$(function(){$(document).on("change","[name=paymentMethod]",function(t){t.preventDefault(),app.cartUtil.updateView()}),$(document).on("click",".add-to-cart",function(t){t.preventDefault();var e=$(this).data("product"),a=$(this).data("qty");if(e){var r=$(this).parents("#product-section").find(".pieces"),n=parseInt(r.val())||1;app.cartUtil.addItem(e,n,a)}else console.warn("Could not add to cart, [data-product] attribute missing on.",$(this))}),$(document).on("mouseover",".num-items-in-cart",function(t){var r=$(this);!app.cartUtil.viewNotUpdated&&window.cartXHR&&"resolved"!=window.cartXHR.state()||(window.cartXHR=$.ajax("/cart/mini").then(function(t,e,a){"string"==typeof t?(r.data("loadedAt",(new Date).getTime()),$("#cart-info").html(t),app.cartUtil.viewNotUpdated=!1):"error"==t.status?console.error(t.message):app.cartUtil.updateView(window.cart=t)}))}),$(document).on("change",".cart-pieces",function(t){t.preventDefault();var e=$(this).val(),a=$(this).parents("[data-cartid]").data("cartid");app.cartUtil.updateItem(a,e)}),$(document).on("click",".cart-remove",function(t){t.preventDefault();var e=$(this).parents("[data-cartid]").data("cartid");app.cartUtil.removeItem(e)}),$(document).on("click",".pieces-minus",function(){var t=$(this).siblings(".pieces"),e=parseInt(t.val())||1;t.val(--e);var a=$(this).parents("[data-cartid]").data("cartid");a?app.cartUtil.updateItem(a,e):console.warn("Could not get cart id!!")}),$(document).on("click",".pieces-plus",function(){var t=$(this).siblings(".pieces"),e=parseInt(t.val())||1;t.val(++e);var a=$(this).parents("[data-cartid]").data("cartid");a?app.cartUtil.updateItem(a,e):console.warn("Could not get cart id!!")}),$(document).on("change","#change-quantity",function(t){t.preventDefault();var e=$(this).find(":selected").data("option");console.log(e),$("#product-data").attr("data-product",e);var a=$(this).val();$("#product-price").html(a);var r=$(this).find(":selected").text().trim();$(".add-to-cart").data("qty",r)}),$(document).on("click","#checkout-form",function(t){t.preventDefault();var e=$("#name").val(),a=$("#phone").val(),r=$("#location").val(),n=$("#street").val(),i=$("#building").val(),o=$("#houseno").val(),c=app.csrf_token,s=$("#email").val();if(""!=e&&""!=a&&""!=r&&""!=s)data={street:n,building:i,houseno:o,name:e,cell:a,location:r,email:s,_csrf:c},$.ajax({headers:{"X-CSRF-Token":app.csrf_token},type:"get",url:"/cart/checkout/"+e+"/"+r+"/"+a+"/"+s+"/"+n+"/"+i+"/"+o,data:data,success:function(t){console.log(t),t.state&&(window.location.href="/order-placed")},error:function(t,e,a){console.log(t,e,a)}});else{$(".checkout-error").html("Please fill all the fields and try again")}})});