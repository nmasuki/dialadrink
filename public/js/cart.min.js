var cartUtil=function(){var self=this;self.locations=JSON.parse(sessionStorage.locations||"[]");var _cart={},_promo=null,_url="/api/",locationNai={lat:-1.2829442,lng:36.8227554};function distance(t,e,a){if(t.lat==e.lat&&t.lng==e.lng)return 0;var n=Math.PI*t.lat/180,r=Math.PI*e.lat/180,e=t.lng-e.lng,e=Math.PI*e/180,e=Math.sin(n)*Math.sin(r)+Math.cos(n)*Math.cos(r)*Math.cos(e);return 1<e&&(e=1),e=60*(e=180*(e=Math.acos(e))/Math.PI)*1.1515,"K"==a&&(e*=1.609344),"N"==a&&(e*=.8684),e}function area(t){return Math.PI/180*Math.pow(6378100,2)*Math.abs(Math.sin(t.northeast.lat)-Math.sin(t.southwest.lat))*Math.abs(t.northeast.lng-t.southwest.lng)}function distanceFromNai(t){return distance(t,locationNai,"K")}function loadRegionData(r){if(self._loadingRegions&&"resolved"!=self._loadingRegions.state())return self._loadingRegions;if(!self.locations||!self.locations.length)return self._loadingRegions=$.get(_url+"locations").then(function(t){if("success"==t.response){sessionStorage.locations=self.locations=t.data;t=self.locations.find(function(t){return"CBD"==t.name});return t&&(window.addressData||(window.addressData=Object.assign({freeDeliveryThreashold:500},t)),locationNai=t.location),loadRegionData(r)}});r=r||window.addressData&&window.addressData.location;var t=Math.round(10*distanceFromNai(r))/10,e=self.locations.filter(function(t){return t.viewport}).filter(function(t){return e=r,a=t.viewport,n=e.lng<a.northeast.lng,t=e.lng>a.southwest.lng,t=a.northeast.lng<a.southwest.lng?n||t:n&&t,e.lat>a.southwest.lat&&e.lat<a.northeast.lat&&t;var e,a,n}).filter(function(t){return"drinks-delivery-kenya"!=t.href}).orderByDescending(function(t){return.01*distanceFromNai(t.location)+area(t.viewport)});return window.regionData=Object.assign({deliveryDistance:t,freeDeliveryThreashold:1e3,deliveryCharges:200*t},e.last()||{}),self.updateView(),$.Deferred().resolve(window.regionData.deliveryCharges)}function getProductFromView(t){return{_id:t.split("|").first(),href:"",name:"",currency:"",priceOptions:[{option:{quantity:t.split("|").last(),currency:""}}],image:{secure_url:null}}}function getItemView(n){var r,t=self.view().find("[data-cartid='"+n+"']");return t.length<=0&&(r=$("#cart-template").html(),self.view().each(function(t,e){var a=$(r);a.find("li").data("cartId",n),$(e).prepend(a)}),t=self.view().find("[data-cartid='"+n+"']")),t}function fillIn(e){var t=e.product.priceOptions.find(function(t){return t.option.quantity===e.quantity}),a=e.price||(t.offerPrice&&t.price>t.offerPrice?t.offerPrice:t.price);return e._id=e._id||e.product._id+"|"+e.quantity,e.image=e.image||e.product.image,e.currency=e.currency||t.currency,e.price=a,e}return self=Object.assign(self,{view:function(t){var e=$("#cart-content-main, #cart-content-mini");return t?e.find(t):e},init:function(){return loadRegionData(),$.get(_url+"cart/get").then(function(t){for(var e in _cart=t.cart,_promo=t.promo,_cart)_cart[e]=fillIn(_cart[e]);self.updateView()})},getCart:function(){return _cart||{}},loadCharges:loadRegionData,getCharges:function getCharges(){if(!window.regionData)return loadRegionData().then(getCharges);var charges={},categories=Object.values(self.getCart()).map(function(t){return t.product&&t.product.category&&t.product.category.key}).distinct();1==categories.length&&0<=["others","extras","extra"].indexOf(categories[0])&&(charges.deliveryCharges=Math.max(200,charges.deliveryCharges)),self.totalCost()<window.regionData.freeDeliveryThreashold&&(charges.deliveryCharges=window.regionData.deliveryCharges);var paymentMode=$("[name=paymentMethod]:checked").val(),mapping,v;return paymentMode&&(mapping={"Swipe on Delivery":"2.5%",PesaPal:"3%"},mapping[paymentMode]&&(v=mapping[paymentMode].replace("%","/100"),/[^\d\.]/.test(v)&&(v=eval(v)*self.totalCost()),charges.transactionCharges=v)),charges},getCartItem:function(t){return _cart[t]},addItem:function(t,e,a){self.view(".number");var n=t+"|"+(a=a||""),r=_cart[n]||(_cart[n]={_id:n,pieces:0});return r.pieces+=e,self.updateView(),app&&app.showToast&&app.showToast("Adding to cart!"),self.viewNotUpdated=!0,$.ajax({url:_url+"cart/add/"+t+"/"+a+"/"+(e||1),type:"get",success:function(t){console.log("Added to cart",t,e),app.showToast(e+" "+t.item.product.name+" added to cart!",1500,"green"),_cart[n]=fillIn(Object.assign(r,t.item)),self.updateView(),"function"==typeof window.subscribeToPush&&window.subscribeToPush()},fail:function(){console.warn("Added to cart fails. Could not reach Server"),app.showToast("Added to cart fails. Could not reach Server!",1500,"red"),r.pieces-=e,self.updateView(),self.viewNotUpdated=!1}})},updateItem:function(e,t){if(t<=0)return self.removeItem(e);var a=_cart[e]||(_cart[e]={_id:e,pieces:t});return self.updateView(),$.ajax({url:_url+"cart/update/"+e+"/"+t,type:"get",success:function(t){_cart[e]=fillIn(Object.assign(a,t.item)),self.updateView()}})},removeItem:function(e){var a=this;if(!_cart[e])throw"Cart item not found! "+e;var n=a.view("li[data-cartid='"+e+"']");return n.slideUp(),$.ajax({url:_url+"cart/remove/"+e,type:"post",success:function(t){t.state?(delete _cart[e],a.updateView()):(n.slideDown(),app.showToast("Failed to remove cart item "+t.msg,1500,"red"))}})},piecesCount:function(){var t,e=0;for(t in _cart)e+=parseInt(_cart[t].pieces);return e},productCount:function(){return Object.values(_cart||{}).distinct(function(t){return t.product&&t.product._id}).length},totalCost:function(){var t,e=0;for(t in _cart)e+=_cart[t].pieces*_cart[t].price;return e},totalAmount:function(){var t,e=self.totalCost(),a=0,n=self.getCharges()||{};for(t in n)n.hasOwnProperty(t)&&(a+=n[t]);return e+a-self.discount(e)},discount:function(t,e){return t=t||self.totalCost(),(e=e||_promo)&&e.discountType?Math.round("percent"===e.discountType?t*e.discount/100:e.discount):0},updateView:function(e,t){e=e||_cart||{},t=t||_promo,Object.values(e).forEach(self.updateCartItemView),Object.keys(_cart||{}).forEach(function(t){(!e[t]||e[t].pieces<=0)&&self.view("li[data-cartid='"+t+"']").slideUp()});var a=$(".promo-code-wrapper");t&&t.discountType&&self.discount(null,t)?(a.find(".promo-code").text(t.code),a.find(".promo-code-amount").text(self.discount(null,t).formatNumber(2)),a.slideDown()):a.hide();var n=self.getCharges(),r=$(".transaction-charges"),a=$(".delivery-charges");n.transactionCharges?(r.find(".cart-amount").text(n.transactionCharges.formatNumber(2)),r.slideDown()):r.hide(),n.deliveryCharges?(r="Delivery charges",window.regionData.name?r+=" ("+window.regionData.name+")":window.regionData.deliveryDistance&&(r+=" ("+window.regionData.deliveryDistance+"KM)"),a.find("h6").text(r),a.find(".cart-amount").text(n.deliveryCharges.formatNumber(2)),a.slideDown()):a.hide(),console.log(n),_cart=e,_promo=t,self.updateTotals()},updateCartItemView:function(e){if(!(e="string"==typeof e?self.getCartItem(e):e))throw"Missing [item] when updating cart item view";if(!e._id)throw"Missing [item._id] when updating cart item view";var t,a=getItemView(e.cartId||e._id+"|"+e.quantity);e.pieces<=0?a.slideUp():a.slideDown(),a.find(".cart-description").html((e.description||"").truncate(50)),a.find(".cart-price").html((e.pieces*e.price).formatNumber(2)),a.find(".cart-pieces").html(e.pieces),e.product=e.product||getProductFromView(e._id),e.product?(a.find(".cart-image").attr("src",e.product.image.secure_url),a.find(".cart-product-link").attr("href",e.product.href).html(e.product.name+" "+e.quantity),e.product.priceOptions&&(t=e.product.priceOptions.find(function(t){return t.option.quantity===e.quantity}),a.find(".cart-currency").html(e.currency||t&&t.currency||"KES"),a.find(".cart-price").html((e.pieces*e.price).formatNumber(2)))):app.cartUtil.viewNotUpdated=!0},updateTotals:function(){$(".cart-total-products").html(self.productCount()),$(".cart-total-pieces").html(self.piecesCount()),["/checkout","/cart"].find(function(t){return 0<=window.location.href.indexOf(t)})?($(".shop-by-brand").hide(),$(".inst-checkout").hide()):0<self.piecesCount()?$(".inst-checkout").slideDown():$(".inst-checkout").slideUp();var t=self.totalAmount().formatNumber(2);self.totalAmount()<self.totalCost()&&(t="<span style='font-size: 0.8em; text-decoration: line-through; color: orangered'>{0}</span>&nbsp;".format(self.totalCost().formatNumber(2))+t),$(".cart-total, .cart-total-2").html(t)}}),self.init(),self};window.app=window.app||{cartUtil:new cartUtil},$(function(){$(document).on("change","[name=paymentMethod]",function(t){t.preventDefault(),app.cartUtil.updateView()}),$(document).on("click",".add-to-cart-2",function(t){var e=$(this).data("product"),r=JSON.parse($("#json"+e).text());console.log(r);var a="<a href='{1}'><img src='{0}' style='width: 100%; max-width: 90px;'/></a>".format(r.image.secure_url,r.href),e=r.options.map(function(t,e){return"<label><input type='radio' class='option' name='priceOption' value='{0}' {3}/> {0} - {1} {2}</label>".format(t.quantity,t.currency,t.price,0==e?"checked":"")}).join("<br/>"),i=$('<div class="row price-options"><div class="col-md-2 col-sm-2">{0}</div><div class="col-md-6 col-sm-6">{1}</div><div class="col-md-4 col-sm-4">{2}</div></div>'.format(a,e,'<div class="product-qty"><span class="pieces-plus btn btn-default btn-lg btn-qty" style="width: 40px;padding: 3px 3px 3px 5px;color: black !important;"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></span><input value="1" class="pieces btn btn-default btn-lg btn-qty" style="background-color:white;width: 48px;height: 40px;padding: 5px 4px 4px 4px;color: black !important;"><span class="pieces-minus btn btn-default btn-lg btn-qty" style="width: 40px;padding: 3px 3px 3px 5px;color: black !important;">    <span class="glyphicon glyphicon-minus" aria-hidden="true"></span></span></div>',r.name)),o=app.showModal({title:r.name+" options",msg:i,buttons:{Ok:function(t){var e=r._id,a=i.find("input[type=radio]:checked").val(),n=parseInt(i.find(".pieces").val()||"1")||1;e&&a?(app.cartUtil.addItem(e,n,a),o.modal("hide")):console.warn("Could not add to cart, [data-product] attribute missing on.",$(this))}}})}),$(document).on("click",".add-to-cart",function(t){t.preventDefault();var e=$(this).data("product"),a=$(this).data("qty");e?(t=$(this).parents("#product-section").find(".pieces"),t=parseInt(t.val())||1,app.cartUtil.addItem(e,t,a)):console.warn("Could not add to cart, [data-product] attribute missing on.",$(this))}),$(document).on("mouseover",".num-items-in-cart",function(t){var n=$(this);!app.cartUtil.viewNotUpdated&&window.cartXHR&&"resolved"!=window.cartXHR.state()||(window.cartXHR=$.ajax("/cart/mini").then(function(t,e,a){"string"==typeof t?(n.data("loadedAt",(new Date).getTime()),$("#cart-info").html(t),app.cartUtil.viewNotUpdated=!1):"error"==t.status?console.error(t.message):app.cartUtil.updateView(window.cart=t)}))}),$(document).on("change",".cart-pieces",function(t){t.preventDefault();var e=$(this).val(),t=$(this).parents("[data-cartid]").data("cartid");app.cartUtil.updateItem(t,e)}),$(document).on("click",".cart-remove",function(t){t.preventDefault();t=$(this).parents("[data-cartid]").data("cartid");app.cartUtil.removeItem(t)}),$(document).on("click",".pieces-minus",function(){var t=$(this).siblings(".pieces"),e=parseInt(t.val())||1;t.val(--e);t=$(this).parents("[data-cartid]").data("cartid");t?app.cartUtil.updateItem(t,e):console.warn("Could not get cart id!!")}),$(document).on("click",".pieces-plus",function(){var t=$(this).siblings(".pieces"),e=parseInt(t.val())||1;t.val(++e);t=$(this).parents("[data-cartid]").data("cartid");t?app.cartUtil.updateItem(t,e):console.warn("Could not get cart id!!")}),$(document).on("change",".price-options .option",function(t){t.preventDefault();t=$(this).data("option");console.log(t),$("#product-data").attr("data-product",t);t=$(this).data("value");$("#product-price").html(t);t=$(this).val();$(".add-to-cart").data("qty",t)}),$(document).on("click","#checkout-form",function(t){t.preventDefault();var e=$("#name").val(),a=$("#phone").val(),n=$("#location").val(),r=$("#street").val(),i=$("#building").val(),o=$("#houseno").val(),c=app.csrf_token,t=$("#email").val();""!=e&&""!=a&&""!=n&&""!=t?(data={street:r,building:i,houseno:o,name:e,cell:a,location:n,email:t,_csrf:c},$.ajax({headers:{"X-CSRF-Token":app.csrf_token},type:"get",url:"/cart/checkout/"+e+"/"+n+"/"+a+"/"+t+"/"+r+"/"+i+"/"+o,data:data,success:function(t){console.log(t),t.state&&(window.location.href="/order-placed")},error:function(t,e,a){console.log(t,e,a)}})):$(".checkout-error").html("Please fill all the fields and try again")})});