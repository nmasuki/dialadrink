var cartUtil=function(){var n={},r=null;function c(e){var t=e.product.priceOptions.find(function(t){return t.option.quantity===e.quantity}),a=e.price||(t.offerPrice&&t.price>t.offerPrice?t.offerPrice:t.price);return e._id=e._id||e.product._id+"|"+e.quantity,e.image=e.image||e.product.image,e.currency=e.currency||t.currency,e.price=a,e}var o=Object.assign(this,{view:function(t){var e=$("#cart-content-main, #cart-content-mini");return t?e.find(t):e},init:function(){return $.get("/cart/get").then(function(t){for(var e in n=t.cart,r=t.promo,n)n[e]=c(n[e]);o.updateView()})},getCart:function(){return n},getCartItem:function(t){return n[t]},addItem:function(t,e,a){o.view(".number");var r=t+"|"+(a=a||""),i=n[r]||(n[r]={_id:r,pieces:0});return i.pieces+=e,o.updateView(),app.showToast("Adding to cart!"),o.viewNotUpdated=!0,$.ajax({url:"/cart/add/"+t+"/"+a+"/"+(e||1),type:"get",success:function(t){console.log("Added to cart",t,e),app.showToast(e+" "+t.item.product.name+" added to cart!",1500,"green"),n[r]=c(Object.assign(i,t.item)),o.updateView()},fail:function(){console.warn("Added to cart fails. Could not reach Server"),app.showToast("Added to cart fails. Could not reach Server!",1500,"red"),i.pieces-=e,o.updateView(),o.viewNotUpdated=!1}})},updateItem:function(e,t){var a=n[e]||(n[e]={_id:e,pieces:t});return o.updateView(),$.ajax({url:"/cart/update/"+e+"/"+t,type:"get",success:function(t){n[e]=c(Object.assign(a,t.item)),o.updateView()}})},removeItem:function(e){var a=this;if(!n[e])throw"Cart item not found! "+e;var r=a.view("li[data-cartid='"+e+"']");return r.hide(),$.ajax({url:"/cart/remove/"+e,type:"get",success:function(t){t.state?(delete n[e],a.updateView()):(r.show(),app.showToast("Failed to remove cart item "+t.msg,1500,"red"))}})},piecesCount:function(){var t=0;for(var e in n)t+=parseInt(n[e].pieces);return t},productCount:function(){return Object.values(n).distinct(function(t){return t.product&&t.product._id}).length},totalCost:function(){var t=0;for(var e in n)t+=n[e].pieces*n[e].price;return t},totalAmount:function(){var t=o.totalCost();return t-o.discount(t)},discount:function(t,e){return t=t||o.totalCost(),(e=e||r)&&e.discountType?Math.round("percent"===e.discountType?t*e.discount/100:e.discount):0},updateView:function(e,t){e=e||n,t=t||r,Object.values(e).forEach(o.updateCartItemView),Object.keys(n).forEach(function(t){e[t]||o.view("li[data-cartid='"+t+"']").hide()});var a=$(".promo-code-wrapper").slideDown();t&&t.discountType&&o.discount(null,t)?(a.find(".promo-code").text(t.code),a.find(".promo-code-amount").text(o.discount(null,t).formatNumber(2))):a.hide(),n=e,r=t,o.updateTotals()},updateCartItemView:function(e){if("string"==typeof e&&(e=o.getCartItem(e)),!e)throw"Missing [item] when updating cart item view";if(!e._id)throw"Missing [item._id] when updating cart item view";var t,a=function(r){var t=o.view().find("[data-cartid='"+r+"']");if(t.length<=0){var i=$("#cart-template").html();o.view().each(function(t,e){var a=$(i);a.find("li").data("cartId",r),$(e).prepend(a)}),t=o.view().find("[data-cartid='"+r+"']")}return t}(e._id);if(a.find(".cart-description").html((e.description||"").truncate(50)),a.find(".cart-price").html((e.pieces*e.price).formatNumber(2)),a.find(".cart-pieces").html(e.pieces),e.product=e.product||{_id:(t=e._id).split("|").first(),href:"",name:"",currency:"",priceOptions:[{option:{quantity:t.split("|").last(),currency:""}}],image:{secure_url:null}},e.product){if(a.find(".cart-image").attr("src",e.product.image.secure_url),a.find(".cart-product-link").attr("href",e.product.href).html(e.product.name+" "+e.quantity),e.product.priceOptions){var r=e.product.priceOptions.find(function(t){return t.option.quantity===e.quantity});a.find(".cart-currency").html(e.currency||r&&r.currency||"KES"),a.find(".cart-price").html((e.pieces*e.price).formatNumber(2))}}else app.cartUtil.viewNotUpdated=!0},updateTotals:function(){$(".cart-total-products").html(o.productCount()),$(".cart-total-pieces").html(o.piecesCount());var t=o.totalAmount().formatNumber(2);o.totalAmount()!==o.totalCost()&&(t="<span style='font-size: 0.8em; text-decoration: line-through; color: orangered'>{0}</span>".format(o.totalCost().formatNumber(2))+t),$(".cart-total").html(t)}});return o.init(),o};window.app=window.app||{cartUtil:new cartUtil},$(function(){$(document).on("click",".add-to-cart",function(t){t.preventDefault();var e=$(this).data("product"),a=$(this).data("qty");if(e){console.log("The id is this after changes",e);var r=$(this).parents("#product-section").find(".pieces"),i=parseInt(r.val())||1;app.cartUtil.addItem(e,i,a)}else console.warn("Could not add to cart, [data-product] attribute missing on.",$(this))}),$(document).on("mouseover",".num-items-in-cart",function(t){var r=$(this);!app.cartUtil.viewNotUpdated&&window.cartXHR&&"resolved"!=window.cartXHR.state()||(window.cartXHR=$.ajax("/cart/mini").then(function(t,e,a){"string"==typeof t?(r.data("loadedAt",(new Date).getTime()),$("#cart-info").html(t),app.cartUtil.viewNotUpdated=!1):app.cartUtil.updateView(window.cart=t)}))}),$(document).on("change",".cart-pieces",function(t){t.preventDefault();var e=$(this).val(),a=$(this).parents("[data-cartid]").data("cartid");app.cartUtil.updateItem(a,e)}),$(document).on("click",".cart-remove",function(t){t.preventDefault();var e=$(this).parents("[data-cartid]").data("cartid");app.cartUtil.removeItem(e)}),$(document).on("click",".pieces-minus",function(){var t=$(this).siblings(".pieces"),e=parseInt(t.val())||1;t.val(--e);var a=$(this).parents("[data-cartid]").data("cartid");a?app.cartUtil.updateItem(a,e):console.warn("Could not get cart id!!")}),$(document).on("click",".pieces-plus",function(){var t=$(this).siblings(".pieces"),e=parseInt(t.val())||1;t.val(++e);var a=$(this).parents("[data-cartid]").data("cartid");a?app.cartUtil.updateItem(a,e):console.warn("Could not get cart id!!")}),$(document).on("change","#change-quantity",function(t){t.preventDefault();var e=$(this).find(":selected").data("option");console.log(e),$("#product-data").attr("data-product",e);var a=$(this).val();$("#product-price").html(a);var r=$(this).find(":selected").text().trim();$(".add-to-cart").data("qty",r)}),$(document).on("click","#checkout-form",function(t){t.preventDefault();var e=$("#name").val(),a=$("#phone").val(),r=$("#location").val(),i=$("#street").val(),n=$("#building").val(),c=$("#houseno").val(),o=app.csrf_token,d=$("#email").val();if(""!=e&&""!=a&&""!=r&&""!=d)data={street:i,building:n,houseno:c,name:e,cell:a,location:r,email:d,_csrf:o},$.ajax({headers:{"X-CSRF-Token":app.csrf_token},type:"get",url:"/cart/checkout/"+e+"/"+r+"/"+a+"/"+d+"/"+i+"/"+n+"/"+c,data:data,success:function(t){console.log(t),t.state&&(window.location.href="/order-placed")},error:function(t,e,a){console.log(t,e,a)}});else{$(".checkout-error").html("Please fill all the fields and try again")}})});