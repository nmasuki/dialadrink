var cartUtil=function(){var i={},r=null;function c(e){var t=e.product.priceOptions.find(function(t){return t.option.quantity===e.quantity}),a=e.price||(t.offerPrice&&t.price>t.offerPrice?t.offerPrice:t.price);return e._id=e._id||e.product._id+"|"+e.quantity,e.image=e.image||e.product.image,e.currency=e.currency||t.currency,e.price=a,e}var o=Object.assign(this,{view:function(t){var e=$("#cart-content-main, #cart-content-mini");return t?e.find(t):e},init:function(){return $.get("/cart/get").then(function(t){for(var e in i=t.cart,r=t.promo,i)i[e]=c(i[e]);o.updateView()})},getCart:function(){return i},getCartItem:function(t){return i[t]},addItem:function(t,e,a){o.view(".number");var r=t+"|"+(a=a||""),n=i[r]||(i[r]={});return app.showToast("Adding to cart!"),$.ajax({url:"/cart/add/"+t+"/"+a+"/"+(e||1),type:"get",success:function(t){console.log("Added to cart",t,e),app.showToast(e+" "+t.item.product.name+" added to cart!",1500,"green"),i[r]=c(Object.assign(n,t.item)),o.updateView()},fail:function(){console.warn("Added to cart fails. Could not reach Server"),app.showToast("Added to cart fails. Could not reach Server!",1500,"red")}})},updateItem:function(e,t){var a=i[e]||(i[e]={});return $.ajax({url:"/cart/update/"+e+"/"+t,type:"get",success:function(t){i[e]=c(Object.assign(a,t.item)),o.updateView()}})},removeItem:function(e){var a=this;if(!i[e])throw"Cart item not found! "+e;return $.ajax({url:"/cart/remove/"+e,type:"get",success:function(t){t.state?(a.view("li[data-cartid='"+e+"']").hide(),delete i[e],a.updateTotals()):console.log("Failed to remove cart item "+e,t.msg)}})},piecesCount:function(){var t=0;for(var e in i)t+=parseInt(i[e].pieces);return t},productCount:function(){return Object.values(i).distinct(function(t){return t.product._id}).length},totalCost:function(){var t=0;for(var e in i)t+=i[e].pieces*i[e].price;return t},totalAmount:function(){var t=o.totalCost();return t-o.discount(t)},discount:function(t,e){return t=t||o.totalCost(),(e=e||r)&&e.discountType?Math.round("percent"===e.discountType?t*e.discount/100:e.discount):0},updateView:function(e,t){e=e||i,t=t||r,Object.values(e).forEach(o.updateCartItemView),Object.keys(i).forEach(function(t){e[t]||o.view("li[data-cartid='"+t+"']").hide()});var a=$(".promo-code-wrapper").slideDown();t&&t.discountType&&o.discount(null,t)?(a.find(".promo-code").text(t.code),a.find(".promo-code-amount").text(o.discount(null,t).formatNumber(2))):a.hide(),i=e,r=t,o.updateTotals()},updateCartItemView:function(e){if("string"==typeof e&&(e=o.getCartItem(e)),!e)throw"Missing [item] when updating cart item view";if(!e._id)throw"Missing [item._id] when updating cart item view";var t=function(r){var t=o.view().find("[data-cartid='"+r+"']");if(t.length<=0){var n=$("#cart-template").html();o.view().each(function(t,e){var a=$(n);a.find("li").data("cartId",r),$(e).prepend(a)}),t=o.view().find("[data-cartid='"+r+"']")}return t}(e._id);t.find(".cart-image").attr("src",e.product.image.secure_url),t.find(".cart-product-link").attr("href",e.product.href).html(e.product.name+" "+e.quantity),t.find(".cart-description").html((e.description||"").truncate(50)),t.find(".cart-pieces").html(e.pieces);var a=e.product.priceOptions.find(function(t){return t.option.quantity===e.quantity});t.find(".cart-currency").html(e.currency||a.currency||"KES"),t.find(".cart-price").html((e.pieces*e.price).formatNumber(2))},updateTotals:function(){$(".cart-total-products").html(o.productCount()),$(".cart-total-pieces").html(o.piecesCount());var t=o.totalAmount().formatNumber(2);o.totalAmount()!==o.totalCost()&&(t="<span style='font-size: 0.8em; text-decoration: line-through; color: orangered'>{0}</span>".format(o.totalCost().formatNumber(2))+t),$(".cart-total").html(t)}});return o.init(),o};window.app=window.app||{cartUtil:new cartUtil},$(function(){$(document).on("click",".add-to-cart",function(t){t.preventDefault();var e=$(this).data("product"),a=$(this).data("qty");if(e){console.log("The id is this after changes",e);var r=$(this).parents("#product-section").find(".pieces"),n=parseInt(r.val())||1;app.cartUtil.addItem(e,n,a)}else console.warn("Could not add to cart, [data-product] attribute missing on",$(this))}),$(document).on("change",".cart-pieces",function(t){t.preventDefault();var e=$(this).val(),a=$(this).parents("[data-cartid]").data("cartid");app.cartUtil.updateItem(a,e)}),$(document).on("click",".cart-remove",function(t){t.preventDefault();var e=$(this).parents("[data-cartid]").data("cartid");app.cartUtil.removeItem(e)}),$(document).on("click",".pieces-minus",function(){var t=$(this).siblings(".pieces"),e=parseInt(t.val())||1;t.val(--e);var a=$(this).parents("[data-cartid]").data("cartid");a?app.cartUtil.updateItem(a,e):console.warn("Could not get cart id!!")}),$(document).on("click",".pieces-plus",function(){var t=$(this).siblings(".pieces"),e=parseInt(t.val())||1;t.val(++e);var a=$(this).parents("[data-cartid]").data("cartid");a?app.cartUtil.updateItem(a,e):console.warn("Could not get cart id!!")}),$(document).on("change","#change-quantity",function(t){t.preventDefault();var e=$(this).find(":selected").data("option");console.log(e),$("#product-data").attr("data-product",e);var a=$(this).val();$("#product-price").html(a);var r=$(this).find(":selected").text().trim();$(".add-to-cart").data("qty",r)}),$(document).on("click","#checkout-form",function(t){t.preventDefault();var e=$("#name").val(),a=$("#phone").val(),r=$("#location").val(),n=$("#street").val(),i=$("#building").val(),c=$("#houseno").val(),o=app.csrf_token,d=$("#email").val();if(""!=e&&""!=a&&""!=r&&""!=d)data={street:n,building:i,houseno:c,name:e,cell:a,location:r,email:d,_csrf:o},$.ajax({headers:{"X-CSRF-Token":app.csrf_token},type:"get",url:"/cart/checkout/"+e+"/"+r+"/"+a+"/"+d+"/"+n+"/"+i+"/"+c,data:data,success:function(t){console.log(t),t.state&&(window.location.href="/order-placed")},error:function(t,e,a){console.log(t,e,a)}});else{$(".checkout-error").html("Please fill all the fields and try again")}})});