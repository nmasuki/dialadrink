<style>
    form.promo-redeem {
        padding: 22px;
    }

    form.needs-validation {
        padding: 0 22px;
    }

    form.promo-redeem button {
        margin-top: 0;
        border-bottom-left-radius: 0;
        border-top-left-radius: 0;
        border-left: none;
    }

    form.promo-redeem button, form.needs-validation button {
        border: 1px solid lightgray;
        color: white;
    }

    form.promo-redeem input {
        margin: 0;
        padding: 19px;
    }

    form.needs-validation {
        margin: 2px 5px;
    }

    h4.mb-3 {
        margin-left: 20px;
    }

    form .mb-3 input {
        width: 281px;
    }

    .invalid-feedback {
        display: none;
    }

</style>
<div class="container">
    <div class="row">
        <div class="col-md-4 order-md-2 mb-4">
            <h4 class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">{{#if orderUrl}}Order Items{{else}}Your cart{{/if}}</span>
                {{#if cartItems.length}}
                    <span class="badge badge-secondary badge-pill">{{cartItemCount this}}</span>
                {{/if}}
            </h4>
            <ul class="list-group mb-3">
                {{#if cartItems.length}}
                    {{#each cartItems}}
                        <li data-cartid="{{_id}}"
                            class="list-group-item d-flex justify-content-between lh-condensed row">
                            <div class="col-md-4">
                                <img class="cart-image" src="{{cloudinaryUrl image crop='fit' height=52}}" style="width: 52px; height: 52px">
                            </div>
                            <div class="col-md-8">
                                <h6 class="my-0"><a href="/{{product.href}}">{{product.name}}
                                    &nbsp;{{quantity}}</a>
                                </h6>
                                <small class="text-muted">{{truncate description 50}}</small>
                                <small class="text-muted">
                                    <span class="cart-pieces">{{pieces}}</span> piece{{#ifgt pieces 1}}s{{/ifgt}}
                                    @<span class="cart-currency">KES</span>
                                    <stan class="cart-cost">{{price}}</stan>
                                </small>
                                <div class="right">
							<span class="text-muted">
								<span class="cart-currency">KES</span> 
								<stan class="cart-price">{{formatNumber (prod pieces price)}}</stan>
							</span>
                                </div>
                            </div>
                            <!--<a href='#' class='close cart-remove' data-dismiss='alert'>&times;</a>-->
                        </li>
                    {{/each}}

                    <li class="transaction-charges list-group-item d-flex justify-content-between lh-condensed row" style="display: none;">
                        <div class="text-info">
                            <h6 class="my-0">Transaction Charges</h6>
                        </div>
                        <span class="cart-currency">KES</span> 
                        <span class="text-info cart-amount">100.00</span>
                    </li>

                    <li class="delivery-charges list-group-item d-flex justify-content-between lh-condensed row" style="display: none;">
                        <div class="text-info">
                            <h6 class="my-0">Delivery Charges</h6>
                        </div>
                        <span class="cart-currency">KES</span> 
                        <span class="text-info cart-amount">50.00</span>
                    </li>
                    
                    <li {{#unless promocode}}style="display: none;"{{/unless}}
                        class="promo-code-wrapper list-group-item d-flex justify-content-between bg-light">
                        <div class="text-success">
                            <h6 class="my-0">Promo code</h6>
                            <small class="promo-code">{{promocode.code}}</small>
                        </div>
                        <span class="cart-currency">KES</span>
                        (<span class="text-success promo-code-amount">{{formatNumber promocode.amount}}</span>)
                    </li>

                    <li class="list-group-item d-flex justify-content-between">
                        <span>Total (<span class="cart-currency">KES</span>)</span>
                        <strong class="cart-total-2">
                            {{formatNumber (sumEvals cartItems 'c=>c.pieces*c.price')}}
                        </strong>
                    </li>
                {{else}}
                    <li class="list-group-item d-flex justify-content-between">
                        <div class="loading cart-loading">
                            <img src="https://res.cloudinary.com/nmasuki/image/upload/c_fill/empty-cart.png" alt="Empty!" style="height: 50px;"> You have no items in
                            your cart!!
                        </div>
                        <a href="/">Continue shopping.</a>
                        <p style="font-size: 13px">
                            You can proceed to filling in and saving your delivery details for future references.
                        </p>
                    </li>
                {{/if}}
            </ul>

            {{#if cartItems.length}}
                <form class="card promo-redeem">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-8 col-sm-8" style="width: 74%; float: left;">
                                    <input id="promocode" type="text" class="form-control" placeholder="Promo code" style="/* width: 100%; */float: left;">
                                </div>
                                <div class="col-md-4 col-sm-4" style="width: 21%; float: left; color: white;">
                                    <button type="submit" class="btn btn-secondary" style="margin-top: 0;">Redeem</button>
                                </div>
                            </div>                            
                        </div>
                    </div>
                </form>
            {{/if}}
        </div>

        <div class="col-md-8 order-md-1">
            <div class="row">
                <form method="post" action="/checkout" class="needs-validation billing-address">
                    <div class="row">
                        <h4 class="mb-3">Billing address</h4>
                        <div class="col-md-6 mb-3">
                            <label for="firstName">First name</label>
                            <input type="text" class="form-control" name="firstName" id="firstName" placeholder=""
                                value="{{userData.firstName}}" required="">
                            <div class="invalid-feedback">
                                Valid first name is required.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName">Last name</label>
                            <input type="text" class="form-control" name="lastName" id="lastName" placeholder=""
                                value="{{userData.lastName}}" required="">
                            <div class="invalid-feedback">
                                Valid last name is required.
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email">Phone Number</label>
                            <input type="text" class="form-control" name="phoneNumber" id="phoneNumber"
                                placeholder="0712345678" value="{{userData.phoneNumber}}" pattern="\+?\d+" required>
                            <div class="invalid-feedback">
                                Please enter a valid phone number for shipping updates.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email">Email <span class="text-muted">(Optional)</span></label>
                            <input type="email" class="form-control" name="email" id="email"
                                placeholder="you@example.com" value="{{userData.email}}">
                            <div class="invalid-feedback">
                                Please enter a valid email address for shipping updates.
                            </div>
                        </div>
                    </div>

                    {{#if OkHiKey}}  
                        <div class="row">
                            <button class="btn btn-secondary" id="lets-okhi" style="display: block;">
                                <img src="https://res.cloudinary.com/nmasuki/image/upload/c_scale,e_colorize:100,w_16/v1571922955/icons/locate.png" /> Location lookup
                            </button>
                            <br>
                            <div class="row">
                                <label for="email">Location details</label>
                                <div id="lets-okhi-card"></div>
                            </div>
                        </div>
                    {{/if}} 

                    <div class="row" id="addressInputs" style="{{#if OkHiKey}}display:none;{{/if}}">                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="address">Location</label>
                                <input type="text" class="form-control" name="address" id="address"
                                    value="{{userData.address}}"
                                    placeholder="1234 Kileleshwa" required/>
                                
                                <div class="invalid-feedback">
                                    Please enter your shipping address.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="address2">Apartment</label>
                                <input type="text" class="form-control" name="building" id="address2"
                                    placeholder="Apartment or suite" value="{{userData.building}}">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="address">House Number</label>
                                <input type="text" class="form-control" name="houseNumber" id="houseNumber"
                                    placeholder="House Number" value="{{userData.houseNumber}}">
                            </div>
                        </div>                        
                    </div>
                    {{!--
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="same-address">
                        <label class="custom-control-label" for="same-address">
                            Shipping address is the same as my billing address
                        </label>
                    </div>
                    --}}

                    {{#if cartItems.length}}
                    <hr class="mb-4">
                    <h4 class="mb-3">Payment</h4>

                    <div class="d-block my-3">
                        <div class="custom-control custom-radio">
                            <input id="credit" name="paymentMethod" type="radio" class="custom-control-input" value="Cash" checked>
                            <label class="custom-control-label" for="credit">Cash on Delivery</label>
                        </div>
                        
                        <div class="custom-control custom-radio">
                            <input id="mpesaOnDelivery" name="paymentMethod" type="radio" class="custom-control-input" value="MPESA on delivery">
                            <label class="custom-control-label" for="mpesaOnDelivery">MPESA on Delivery</label>
                        </div>  

                        <div class="custom-control custom-radio">
                            <input id="swipeOnDelivery" name="paymentMethod" type="radio" class="custom-control-input" value="Swipe on Delivery">
                            <label class="custom-control-label" for="swipeOnDelivery">Swipe on Delivery<small>(+2.5% processing fee)</small></label>
                        </div>

                        {{#if enableCyberSource}}
                            <div class="custom-control custom-radio">
                                <input id="cyberSource" name="paymentMethod" type="radio" class="custom-control-input" value="CyberSource">
                                <label class="custom-control-label" for="cyberSource">Pay online</label>
                            </div>
                        {{/if}}

                        {{#if enablePesaPal}}
                            <div class="custom-control custom-radio">
                                <input id="pesaPal" name="paymentMethod" type="radio" class="custom-control-input" value="PesaPal">
                                <label class="custom-control-label" for="pesaPal">Pay online<small>(+3% processing fee)</small></label>
                            </div>
                        {{/if}}
                        
                        {{#if enableMPesa}}
                            <div class="custom-control custom-radio">
                                <input id="mpesa" name="paymentMethod" type="radio" class="custom-control-input" value="MPesa">
                                <label class="custom-control-label" for="mpesa">M-PESA (2% processing fee)</label>
                            </div>
                        {{/if}}
                    </div>
                    {{/if}}

                    <hr class="mb-4">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" checked {{#unless cartItems.length}}disabled{{/unless}} class="custom-control-input" id="saveInfo" name="saveInfo">
                        <label class="custom-control-label" for="saveInfo">Save this information for next time</label>
                    </div>

                    {{!--
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cc-name">Name on card</label>
                            <input type="text" class="form-control" id="cc-name" placeholder="" required="">
                            <small class="text-muted">Full name as displayed on card</small>
                            <div class="invalid-feedback">
                                Name on card is required
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cc-number">Credit card number</label>
                            <input type="text" class="form-control" id="cc-number" placeholder="" required="">
                            <div class="invalid-feedback">
                                Credit card number is required
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="cc-expiration">Expiration</label>
                            <input type="text" class="form-control" id="cc-expiration" placeholder="" required="">
                            <div class="invalid-feedback">
                                Expiration date required
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="cc-expiration">CVV</label>
                            <input type="text" class="form-control" id="cc-cvv" placeholder="" required="">
                            <div class="invalid-feedback">
                                Security code required
                            </div>
                        </div>
                    </div>
                    --}}

                    <div class="alert alert-danger fade in alert-dismissible" style="display: none">
                        <a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">Ã—</a>
                        <span class="msg-text"><strong>Danger!</strong> This alert box indicates a dangerous or potentially negative action.</span>
                    </div>
                    <hr class="mb-4">

                    <div class="row">                          
                        <button class="btn btn-primary btn-lg" id="submitBtn" type="submit">
                            {{#if cartItems.length}}Place your Order{{else}}Save details{{/if}}
                        </button>  
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{{#if OkHiKey}}
<script src="https://cdn.okhi.io/{{{OkHiEnv}}}/web/v4/okhi.min.js"> </script>
<script type="text/javascript"> 
    var okhi = new OkHi({ apiKey: '{{{OkHiKey}}}' });
    var okhiStyle = {
        base: {
            logo: '{{{appLogo}}}',
            name: '{{{appTitle}}}',
            color: '#2f93a3'
        }
    };
    
    {{#if userData.user}}
    window.addressData = {
        user: {{{json  userData.user}}},
        location: {{{json userData.location}}}
    }
    {{/if}}
</script>
<script src="/js/okhi.script{{dotmin}}.js"></script>
{{/if}}

<script type="text/javascript">           
    $(document).ready(function () {   
        window.minifiedMenu = true;
        if (addaffix) addaffix();

        if(window.addressData)
            app.cartUtil.loadCharges(window.addressData.location);

{{#if orderUrl}}
        var iframe = $("<iframe style='min-height: 670px' src='{{orderUrl}}'/>");        
        iframe.css({
            border: "none",
            width:  '100%',
            height: ($("form.needs-validation").height()) + 'px'
        });

        $("form.needs-validation").replaceWith(iframe);
        setTimeout(function(){
            var modal = app.showLoading("<span id='msgSpan'>Loading payment options! Please wait..</span>", 60000);
            iframe.get(0).onload = function(){ 
                modal && modal.modal("hide"); 
            }
        }, 500)
{{/if}}
        
        if($('#lets-okhi').length){
            $("#addressInputs").find("[required]").removeAttr("required")         
        }else{
            $('#lets-okhi').hide();
            $("#addressInputs").attr("required", "true").show();        
        }

        $(document).on("click", ".billing-address button[type='submit']", function (e) {
            e.preventDefault();
            var form = $(this).parents("form");
            var array = form.serializeArray();
            $(".alert-danger").hide();

            if (form[0].checkValidity()) {
                var that = $(this);

                that.attr("disabled", true);
                $('body,html').animate({scrollTop: 0}, 800, 'swing');

                var data = Object.assign({ saveInfo: $("#saveInfo").is(":checked") }, app.cartUtil.getCharges(), window.addressData || {});
                array.forEach(function (a) { data[a.name] = a.value; });

                var modal = app.showLoading("<span id='msgSpan'>Processing your order! Please wait..</span>", 60000);

                $.ajax({
                    url: form.attr("action"),
                    data: JSON.stringify(data),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    type: "POST",
                    success: function (res) {
                        if(res.redirect) {
                            modal.find("span.loading-msg").text("Loading payment options! Please wait..")
                            var iframe = $("<iframe src='" + res.redirect + "'/>");
                            
                            iframe.css({
                                border: "none",
                                width:  '100%',
                                height: (form.height()) + 'px'
                            });

                            form.replaceWith(iframe);
                            iframe.get(0).onload = function(){
                                 modal.modal("hide");
                                 var doc;
                                 try{
                                     doc = this.document || this.contentDocument || this.contentWindow.document;
                                 }catch(e){
                                     console.error(e);
                                 }

                                 console.log("Iframe load!", doc, this, arguments);
                            }
                        } else {
                            app.showModal({
                                msg: res.msg,
                                ok: function (e) {
                                    window.location = "/";
                                },
                                close: function (e) {
                                    window.location = "/";
                                }
                            });
                        }
                        
                    },
                    error: function (xhr, status, error) {
                        app.hideModal();
                        var responseText = xhr.responseText || "Unknown error on '" + that.text() + "'";

                        $(".alert-danger").find(".msg-text").html("<strong>{0}!</strong> {1}. Please try again later..".format(error, responseText));
                        $(".alert-danger").slideDown();

                        $(that).attr("disabled", false).removeAttr("disabled");
                    }
                });

            } else {
                $(".alert-danger").find(".msg-text").html("<strong>Input Error!</strong> Invalid input found! Please review your info above.")
                $(".alert-danger").slideDown();
            }
        });
        
        $(document).on("click", ".promo-redeem button", function (e) {
            e.preventDefault();
            if ($("#promocode").val()) {
                $.get('/checkout/validatepromo/' + $("#promocode").val())
                        .then(function (data) {
                            if (data.state) {
                                app.cartUtil.updateView(null, data.promo);
                                app.showNotification(data.msg)
                            } else {
                                app.showModal({ title: "", msg: data.msg })
                            }
                        });
            }
        })

        var elements = document.getElementsByTagName("INPUT");
        for (var i = 0; i < elements.length; i++) {
            elements[i].oninvalid = function (e) {
                e.target.setCustomValidity("");
                if($( e.target).is(":visible")){
                     if (!e.target.validity.valid) {
                        var errMessage = $(e.target).siblings(".invalid-feedback").text().trim() || "This field cannot be left blank!"
                        e.target.setCustomValidity(errMessage);
                    }
                }else{
                    console.log($( e.target).attr("name") + " is not visible!");
                    e.target.validity.valid = true;
                }
            };
        }
    })
</script>
